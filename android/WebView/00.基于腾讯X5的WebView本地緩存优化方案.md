#### 目录介绍
- 0.问题答疑部分
- 1.业务需求详细描述
    - 1.0 那些因素影响页面加载速度
    - 1.1 一句话简介概括本地缓存
    - 1.2 WebView本地缓存具体业务特点
- 2.实现优化方案思路介绍
    - 2.1 优化方案思维导图
- 3.优化方案中难点重点
    - 3.1 Android网络数据传输中的GZIP压缩
    - 3.2 缓存js，css等文件zip包如何解压
- **4.WebView优化方案实践**
    - 4.1 三端【App，H5，服务器】操作步骤
    - 4.2 资源本地化文件安全【加密解密】
    - 4.3 项目迭代兼容性处理逻辑【版本管理】
    - 4.4 定义配置文件有哪些信息【字段】
    - 4.5 客户端loadurl拦截步骤【重点】
    - 4.6 
- 5.封装库优势描述
    - 5.1 自定义加载进度条
    - 5.2 优雅处理302，303回退栈，白屏
    - 5.3 可以自定义加载失败页面
    - 5.4 支持Java与js之间通信
- 6.市面上WebView开源库分析
    - 6.1 
- 7.封装库使用方法介绍
- 8.测试封装库与WebView加载时间
- 9.WebView性能优化概括
    - 9.1 WebView启动过程阶段
    - 9.2 首次初始化与二次初始化时间对比
    - 9.3 与服务器建立链接
    - 9.4 页面渲染【html，js和css】
    - 9.5 WebView内存消耗的产生
    - 9.6 WebView安全问题和白名单
    - 9.7 WebView.loadUrl(url)加载网页做了什么
    - 9.8 什么时候注入js探索
- 10.封装WebView遇到bug
    - 10.1 常见的bug
        - 10.1.1 WebView页面中播放音视频,退出Activity后仍然有声音
        - 10.1.2 后台无法释放js导致发热耗电
        - 10.1.3 301/302业务场景及白屏问题
        - 10.1.4 301/302重定向问题
        - 10.1.5 301/302回退栈问题
        - 10.1.6 WebSettings.setJavaScriptEnabled安全问题
        - 10.1.7 加载证书错误
        - 10.1.8 WebView播放视频优化问题
        - 10.1.9 WebView内存泄漏问题场景和解决办法
        - 10.2.0 如何处理加载错误(Http、SSL、Resource)？
    - 10.2 解决方案
- 11.回答答疑模块问题
- 12.关于参考案例博客说明
- 13.关于版本更新说明
- 14.关于WebView系列博客


### 0.问题答疑部分
- 0.0.1 WebView什么时候注入js合适？为什么？结合具体情形分析……
- 0.0.2 本地缓存web资源的静态资源，是返回一个zip的文件【总的资源放在一起】，还是分模块返回独立的资源
- 0.0.3 下载静态资源zip包文件，解压后如何缓存到对应的模块H5的Web页面？静态资源中的文件是如何命名文件夹名称的？
- 0.0.4 资源文件本地化的加密操作细节是如何实现的？比如非对称加密该如何实现？
- 0.0.5 如何进行测试封装库，缓存后和没缓存，加载时间和效率上提升多少？如何用数据说明问题？
- 0.0.6 
- 0.1.5 WebView.loadUrl()来加载一个网页到底发生了什么，那么url发生错误、url中的某些内容加载不出来、url里的内容点击无效是是什麽原因导致的？
- 0.1.6 loadUrl方法中WebView在后台请求这个url以后，服务器做了哪些响应，又下发了哪些资源，这些资源的作用是怎么样的？


### 1.业务需求详细描述
#### 1.0 那些因素影响页面加载速度
- 影响页面加载速度的因素有非常多，在对 WebView 加载一个网页的过程进行调试发现
    - 每次加载的过程中都会有较多的网络请求，除了 web 页面自身的 URL 请求
    - 有 web 页面外部引用的JS、CSS、字体、图片等等都是个独立的http请求。这些请求都是串行的，这些请求加上浏览器的解析、渲染时间就会导致 WebView 整体加载时间变长，消耗的流量也对应的真多。





#### 1.1 一句话简介概括
- 移动端web资源【也称H5网页】的本地缓存解决方案，能够拦截webview的请求，并优先使用本地缓存静态资源进行响应，以此来对webview加载页面性能进行优化。
- 其中，需要缓存的静态资源有，js，css，图片(png，jpg，gif，webp)等资源。



#### 1.2 具体业务特点
- 1.2.1 服务端将H5的静态资源，放到一起，并且做好版本控制，还有更新的策略。然后客户端获取服务端返回的静态资源。
- 1.2.2 做好静态资源防止被篡改的策略，比如：白名单管理，比较host是否与我们的url的host相同。
- 1.2.3 静态资源可以自动打包到应用，操作步骤是：第一种是app启动时自动缓存，第二种WebView初始化时自动缓存，及首次安装解压处理。
    - a.此处可以加上强制缓存静态资源，非强制缓存静态资源【原生WebView其实也有缓存】
    - b.也可以设置wifi条件下强制缓存静态资源，4G模式下不强制缓存静态资源
- 1.2.4 协议层要做好拦截请求
- 1.2.5 Android缓存数据到本地文件注意事项：
    - a.判断是否有sd卡，如果有sd卡，则放到sd卡；否则则放到手机存储卡
    - b.如果是存储到手机号，监测到用户安装sd卡，那么则从存储卡复制内容到sd卡
    - c.如果静态资源有更新，则先删除旧的资源，然后再缓存新的资源【不建议覆盖】
    - d.自定义路径，可以设置与下载文件，保存图片相同的路径
- 1.2.6 可以设置自动进行版本检查更新的周期
- 1.2.7 可以设置内存缓存最大的大小值，同时支持用户清除该缓存。



### 2.实现优化方案思路介绍



### 3.优化方案中难点重点
#### 3.1 Android网络数据传输中的GZIP压缩
- Android中的gzip压缩的基本原理:
    - 1.客户端向服务器发送请求,会在请求头带上request.addHeader("Accept-Encoding", "gzip"),告诉服务器客户端支持gzip压缩
    - 2.服务器压缩文件后,客户端通过getContentEncoding()取到Header接口,再根据getValue()去判断返回数据是否已被压缩过,再分别作不同的处理
    - 3.被压缩则解压,没有就正常处理
- 在网络数据传输中,这样做的好处是可以减轻网络传输压力,同时节省传输时间。


#### 3.2 缓存js，css等文件zip包如何解压




### 4.WebView优化方案案例介绍
#### 4.1 三端【App，H5，服务器】操作步骤


#### 4.2 资源本地化文件安全【加密解密】


#### 4.3 项目迭代兼容性处理逻辑【版本管理】

#### 4.4 定义配置文件有哪些信息【字段】
- 每个版本对应的version
- 缓存的路径
- 最大的缓存空间大小(以字节为单位)
- 是否更新update
- 域名集合
- 增删状态操作(删除不需要用的文件)


#### 4.5 客户端loadurl拦截步骤【重点】




### 6.封装库优势描述


### 7.封装库使用方法介绍


### 8.测试封装库与WebView加载时间

### 9.WebView性能优化概括
#### 9.1 WebView启动过程阶段



#### 9.2 首次初始化与二次初始化时间对比



#### 9.3 与服务器建立链接


#### 9.4 页面渲染【html，js和css】
- 在加载页面的过程中，js、css和图片资源占用了大量的流量，如果这些资源一开始就放在本地，或者只需要下载一次，后面重复利用，岂不美哉。
- 缓存优化策略：
    - 能否写一套支持离线缓存WebView资源并实时更新远程资源的解决方案，支持打母包时下载当前最新的资源文件集成到apk中，也支持在线实时更新资源。在WebView中，需要拦截WebViewClient.shouldInterceptRequest()方法，检测缓存是否存在，存在则直接取本地缓存数据，减少网络请求产生的流量。
    - 如果本地有js，css，图片缓存，则webview加载页面时，体验性也更好更流畅一些……



#### 9.5 WebView内存消耗的产生


#### 9.6 WebView安全问题和白名单



#### 9.7 WebView.loadUrl(url)加载网页做了什么
- **9.7.1 执行步骤如下所示**
- 加载网页是一个复杂的过程，在这个过程中，我们可能需要执行一些操作，包括：
- 9.7.1.1 加载网页前，重置WebView状态以及与业务绑定的变量状态。WebView状态包括重定向状态(mTouchByUser)、前端控制的回退栈(mBackStep)等，业务状态包括进度条、当前页的分享内容、分享按钮的显示隐藏等。
- 9.7.1.2 加载网页前，根据不同的域拼接本地客户端的参数，包括基本的机型信息、版本信息、登录信息以及埋点使用的Refer信息等，有时候涉及交易、财产等还需要做额外的配置。
- 9.7.1.3 开始执行页面加载操作时，会回调WebViewClient.onPageStarted(webview,url,favicon)。在此方法中，可以重置重定向保护的变量(mRedirectProtected)，当然也可以在页面加载前重置，由于历史遗留代码问题，此处尚未省去优化。
- 9.7.1.4 加载页面的过程中，WebView会回调几个方法。
WebChromeClient.onReceivedTitle(webview, title)，用来设置标题。需要注意的是，在部分Android系统版本中可能会回调多次这个方法，而且有时候回调的title是一个url，客户端可以针对这种情况进行特殊处理，避免在标题栏显示不必要的链接。
    - WebChromeClient.onProgressChanged(webview, progress)，根据这个回调，可以控制进度条的进度（包括显示与隐藏）。一般情况下，想要达到100%的进度需要的时间较长（特别是首次加载），用户长时间等待进度条不消失必定会感到焦虑，影响体验。其实当progress达到80的时候，加载出来的页面已经基本可用了。事实上，国内厂商大部分都会提前隐藏进度条，让用户以为网页加载很快。
    - WebViewClient.shouldInterceptRequest(webview, request)，无论是普通的页面请求(使用GET/POST)，还是页面中的异步请求，或者页面中的资源请求，都会回调这个方法，给开发一次拦截请求的机会。在这个方法中，我们可以进行静态资源的拦截并使用缓存数据代替，也可以拦截页面，使用自己的网络框架来请求数据。包括后面介绍的WebView免流方案，也和此方法有关。
    - WebViewClient.shouldOverrideUrlLoading(webview, request)，如果遇到了重定向，或者点击了页面中的a标签实现页面跳转，那么会回调这个方法。可以说这个是WebView里面最重要的回调之一，后面WebView与Native页面交互一节将会详细介绍这个方法。
    - WebViewClient.onReceivedError(webview,handler,error)，加载页面的过程中发生了错误，会回调这个方法。主要是http错误以及ssl错误。在这两个回调中，我们可以进行异常上报，监控异常页面、过期页面，及时反馈给运营或前端修改。在处理ssl错误时，遇到不信任的证书可以进行特殊处理，例如对域名进行判断，针对自己公司的域名“放行”，防止进入丑陋的错误证书页面。也可以与Chrome一样，弹出ssl证书疑问弹窗，给用户选择的余地。
- 9.7.1.5 页面加载结束后，会回调WebViewClient.onPageFinished(webview,url)。这时候可以根据回退栈的情况判断是否显示关闭WebView按钮。通过mActivityWeb.canGoBackOrForward(-1)判断是否可以回退。



#### 9.8 什么时候注入js探索
- **9.8.1 onPageFinished()或者onPageStarted()方法中注入js代码**
- 做过WebView开发，并且需要和js交互，大部分都会认为js在WebViewClient.onPageFinished()方法中注入最合适，此时dom树已经构建完成，页面已经完全展现出来。但如果做过页面加载速度的测试，会发现WebViewClient.onPageFinished()方法通常需要等待很久才会回调（首次加载通常超过3s），这是因为WebView需要加载完一个网页里主文档和所有的资源才会回调这个方法。
- 能不能在WebViewClient.onPageStarted()中注入呢？答案是不确定。经过测试，有些机型可以，有些机型不行。在WebViewClient.onPageStarted()中注入还有一个致命的问题——这个方法可能会回调多次，会造成js代码的多次注入。
- 从7.0开始，WebView加载js方式发生了一些小改变，**官方建议把js注入的时机放在页面开始加载之后**。



- **9.8.2 WebViewClient.onProgressChanged()方法中注入js代码**
- WebViewClient.onProgressChanged()这个方法在dom树渲染的过程中会回调多次，每次都会告诉我们当前加载的进度。
    - 在这个方法中，可以给WebView自定义进度条，类似微信加载网页时的那种进度条
    - 如果在此方法中注入js代码，则需要避免重复注入，需要增强逻辑。可以定义一个boolean值变量控制注入时机
- 那么有人会问，加载到多少才需要处理js注入逻辑呢？
    - 正是因为这个原因，页面的进度加载到80%的时候，实际上dom树已经渲染得差不多了，表明WebView已经解析了<html>标签，这时候注入一定是成功的。在WebViewClient.onProgressChanged()实现js注入有几个需要注意的地方：
    - 9.8.2.1 上文提到的多次注入控制，使用了boolean值变量控制
    - 9.8.2.2 重新加载一个URL之前，需要重置boolean值变量，让重新加载后的页面再次注入js
    - 9.8.2.3 如果做过本地js，css等缓存，则先判断本地是否存在，若存在则加载本地，否则加载网络js
    - 9.8.2.4 注入的进度阈值可以自由定制，理论上10%-100%都是合理的，不过建议使用了75%到90%之间可以。


### 10.封装WebView遇到bug
#### 10.1 常见的bug
- 10.1.1 WebView页面中播放音视频,退出Activity后仍然有声音
- 10.1.2 后台无法释放js导致发热耗电
- 10.1.3 301/302业务场景及白屏问题
- 10.1.4 301/302重定向问题
- 10.1.5 301/302回退栈问题
- 10.1.6 WebSettings.setJavaScriptEnabled安全问题
- 10.1.7 加载证书错误
- 10.1.8 WebView播放视频优化问题
- 10.1.9 WebView内存泄漏问题场景和解决办法
- 10.2.0 如何处理加载错误(Http、SSL、Resource)？



#### 10.3 解决方案
- 10.3.1 具体的解决方案请看另一篇博客：


### 10.回答答疑模块问题




### 11.关于参考案例博客说明
#### 11.1 参考的开源项目
- JsBridge【star在5k以上】：https://github.com/lzyzsd/JsBridge
- AgentWeb【star在4k以上】：https://github.com/Justson/AgentWeb
- JsBridge【star500左右】：https://github.com/pengwei1024/JsBridge
- Tencent/VasSonic【star在8k以上】：https://github.com/Tencent/vassonic





#### 11.2 参考的技术博客
- Android Webview + HttpDns最佳实践：https://help.aliyun.com/document_detail/60181.html?spm=5176.11065259.1996646101.searchclickresult.431f492dDakb73
- 如何设计一个优雅健壮的Android WebView？【来自网易考拉】：https://blog.klmobile.app/2018/02/16/design-an-elegant-and-powerful-android-webview-part-one/
- WebView业务场景“IP直连”方案说明：https://help.aliyun.com/document_detail/48972.html?spm=5176.11065259.1996646101.searchclickresult.431f492dDakb73
- WebView性能、体验分析与优化【来自美团技术团队】：https://tech.meituan.com/WebViewPerf.html
- 深入讲解WebView【张涛大神】：https://www.kymjs.com/code/2015/05/03/01/
- Web缓存机制系列6 – 进击的Hybrid App，量身定做缓存机制：http://ju.outofmemory.cn/entry/57401
- JsBridge 实现 JavaScript 和 Java 的互相调用 ：https://juejin.im/entry/573534f82e958a0069b27646
- 考拉Android客户端路由总线设计：https://iluhcm.com/2017/07/12/design-of-router-using-in-android/
- 美团大众点评 Hybrid 化建设：https://zhuanlan.zhihu.com/p/24202408





### 12.关于版本更新说明





### 13.关于WebView系列博客
































